import React, { useEffect, useState } from "react";
import { Grid, Paper, Typography, Box, Card, CardContent, LinearProgress } from "@mui/material";
import MapIcon from "@mui/icons-material/Map";
import NotificationsIcon from "@mui/icons-material/Notifications";
import DevicesIcon from "@mui/icons-material/Devices";
import WarningIcon from "@mui/icons-material/Warning";
import { collection, query, where, onSnapshot, getDocs } from "firebase/firestore";
import { db } from "../../config/firebase";
import RealTimeMap from "../../components/dashboard/RealTimeMap/RealTimeMap";
import ActivityChart from "../../components/dashboard/ActivityChart/ActivityChart";
import RecentAlerts from "../../components/dashboard/RecentAlerts/RecentAlerts";

const StatCard = (props) => {
  const { title, value, icon: Icon, color } = props;
  
  return React.createElement(
    Card,
    { sx: { height: "100%" } },
    React.createElement(
      CardContent,
      null,
      React.createElement(
        Box,
        { display: "flex", alignItems: "center", justifyContent: "space-between" },
        React.createElement(
          Box,
          null,
          React.createElement(
            Typography,
            { color: "textSecondary", gutterBottom: true },
            title
          ),
          React.createElement(
            Typography,
            { variant: "h3", component: "div" },
            value
          )
        ),
        React.createElement(Icon, { sx: { fontSize: 40, color: color } })
      )
    )
  );
};

const DashboardPage = () => {
  const [stats, setStats] = React.useState({
    zones: 0,
    devices: 0,
    alerts: 0,
    violations: 0,
    loading: true
  });

  React.useEffect(() => {
    const loadStats = async () => {
      try {
        const zonesSnap = await getDocs(collection(db, "zones"));
        const devicesSnap = await getDocs(collection(db, "devices"));
        
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        
        const alertsQuery = query(
          collection(db, "geofence_logs"),
          where("timestamp", ">", yesterday)
        );

        setStats(function(prev) {
          return {
            ...prev,
            zones: zonesSnap.size,
            devices: devicesSnap.size,
            loading: false
          };
        });

        const unsubscribe = onSnapshot(alertsQuery, function(snapshot) {
          setStats(function(prev) {
            return {
              ...prev,
              alerts: snapshot.size
            };
          });
        });

        return function() {
          unsubscribe();
        };
      } catch (error) {
        console.error("Error loading stats:", error);
        setStats(function(prev) {
          return { ...prev, loading: false };
        });
      }
    };

    loadStats();
  }, []);

  if (stats.loading) {
    return React.createElement(LinearProgress, null);
  }

  return React.createElement(
    Box,
    { sx: { flexGrow: 1, p: 3 } },
    React.createElement(
      Typography,
      { variant: "h4", gutterBottom: true },
      "Tableau de Bord"
    ),
    React.createElement(
      Grid,
      { container: true, spacing: 3, sx: { mb: 3 } },
      React.createElement(
        Grid,
        { item: true, xs: 12, sm: 6, md: 3 },
        React.createElement(StatCard, {
          title: "Zones actives",
          value: stats.zones,
          icon: MapIcon,
          color: "#1976d2"
        })
      ),
      React.createElement(
        Grid,
        { item: true, xs: 12, sm: 6, md: 3 },
        React.createElement(StatCard, {
          title: "Devices connectés",
          value: stats.devices,
          icon: DevicesIcon,
          color: "#4caf50"
        })
      ),
      React.createElement(
        Grid,
        { item: true, xs: 12, sm: 6, md: 3 },
        React.createElement(StatCard, {
          title: "Alertes 24h",
          value: stats.alerts,
          icon: NotificationsIcon,
          color: "#ff9800"
        })
      ),
      React.createElement(
        Grid,
        { item: true, xs: 12, sm: 6, md: 3 },
        React.createElement(StatCard, {
          title: "Violations",
          value: stats.violations,
          icon: WarningIcon,
          color: "#f44336"
        })
      )
    ),
    React.createElement(
      Grid,
      { container: true, spacing: 3 },
      React.createElement(
        Grid,
        { item: true, xs: 12, md: 8 },
        React.createElement(
          Paper,
          { sx: { p: 2, height: 500 } },
          React.createElement(
            Typography,
            { variant: "h6", gutterBottom: true },
            "Carte en temps réel"
          ),
          React.createElement(RealTimeMap, null)
        )
      ),
      React.createElement(
        Grid,
        { item: true, xs: 12, md: 4 },
        React.createElement(
          Paper,
          { sx: { p: 2, height: 500, overflow: "auto" } },
          React.createElement(
            Typography,
            { variant: "h6", gutterBottom: true },
            "Alertes récentes"
          ),
          React.createElement(RecentAlerts, null)
        )
      ),
      React.createElement(
        Grid,
        { item: true, xs: 12 },
        React.createElement(
          Paper,
          { sx: { p: 2, height: 300 } },
          React.createElement(
            Typography,
            { variant: "h6", gutterBottom: true },
            "Activité des 7 derniers jours"
          ),
          React.createElement(ActivityChart, null)
        )
      )
    )
  );
};

export default DashboardPage;